# Visualizations for Env Chem   

We've already encountered and produced several types of plots to vizualize our data. We've also gone over the theory and basic operations of `ggplot()` in the [Visualizations] chapter. In this chapter, we'll expand on these and explicitly walk through the most common data visualization methods you'll encounter in the field of environmental chemistry. Additionanly, we'll learn how to get your plots ready for publication. 

The plots we'll be covering include: 

  - bar plots
  - scatter plots (with linear regression) 
  - box plots
  - Venn diagrams
  
These are only a smattering of the posibible data visualizations you can perform in R. We're focusing on them becase of their ubiquity in our field, but they often won't be the ideal visualuzations you need to communicate *your story*. We highly recomment you check out the following ressources. Not only are they a great source of inspiration, they provide example code to get you up and running. We consult them regularly: 

  - **[Data to viz](https://www.data-to-viz.com/)** which features a decision tree to help you decide on what plots you need. 
  - **[ggplot2 extensions gallery](https://exts.ggplot2.tidyverse.org/gallery/)** which is the best repository to the plethora of `ggplot2()` extensions. If you need a specialized plot, check here. Odds are someone has a solution to your problem. Some great extensions include [`ggrepel`](https://github.com/slowkow/ggrepel) for easy labelling of points, [`ggpmisc`](https://docs.r4photobiology.info/ggpmisc/) for statistical annotations, and [`ggpubr`](https://rpkgs.datanovia.com/ggpubr/) for pulibcation ready plots. 
  - **[The R Graph Gallery](https://www.r-graph-gallery.com/index.html)** contains hundreds of charts made with R. Not as easy to navigate as *Data to viz*, but contains many more examples; definitly worth exploring. 
  
## data to play with 

```{r}
library(tidyverse)
## Going to include this in the summarize chapter, so it'll be redundant code... 

nfld <- read_csv("data/2018hourlyNO2_NFLD.csv", skip = 7, na =c("-999")) %>%
  rename_with(~tolower(gsub("/.*", "", .x))) %>%
  pivot_longer(cols = starts_with("h"), 
               names_prefix = "h", 
               names_to = "hour", 
               names_transform = list(hour = as.numeric),
               values_to = "conc", 
               values_transform = list(conc = as.numeric),
               values_drop_na = TRUE) 

sumNFLD <- nfld %>%
  group_by(city) %>%
  summarize(mean = mean(conc), 
            sd = sd(conc), 
            median = median(conc), 
            min = min(conc), 
            max = max(conc))
  
kableExtra::kable(sumNFLD, digits = 1)
```

<!-- going to include this stuff in Summarize chapter--> 



As previously mentioned, the *Canadian Ambient Air Quality Standards* stipulate that the annuam mean of 1-hour means for NO~2~ cannot exceed 17.0 ppb in 2020, and 12.0 ppb in 2025. 


## bar plots

```{r}
ggplot(data = sumNFLD,
       aes(x = city, 
           y = mean)) +
  geom_bar(stat = "identity")
```
Pretty boring, but it's gotten the job done. **Note** the `stat = "identity"` call. The default behavior of `geom_bar` is to count the number of observations in a groups, but our data was previously calcualted. `stat = "identity"` simply specifies that our data should remain unchanged. 

### Adding error bars 

Any measurement always has an assosciated uncertainty. In our example, we've used the standard deviation (`sd`) as a measure of uncertainty of our calcualted annual means. 

```{r}
ggplot(data = sumNFLD) +
  geom_bar(aes(x = city, 
               y = mean), 
           stat = "identity") +
  geom_errorbar(aes(x = city, 
                    ymin = mean - sd, 
                    ymax = mean + sd))
```

### Ordering bar charts

Often with bar charts (and similar plots), it's useful to *order* the bars to help tell a story or convey information. We can effectuate this using `fct_reorder()` on the fly:

```{r}
ggplot(data = sumNFLD) +
  geom_bar(aes(x = fct_reorder(city, mean), 
               y = mean), 
           stat = "identity") +
  geom_errorbar(aes(x = city, 
                    ymin = mean - sd, 
                    ymax = mean + sd))
```
So in our aesathetics call for `geom_bar` we specified the `x` variable should be `city`, but ordered based on their corresponding `mean` value. Doing this has helped shed some light on trends in NO~2~ levels. For one, despite Labrador City having lower mean [NO~2~], we can now easily see that it has a larger variation in [NO~2~] then Corner Brook. 

## Box Plots

Box plots give a summary of the *distribution* of a numeric variable. You've no doubt seen them before, but they're often misinterpreteer. Let's create a boxplot, using our Newgoundland hourly NO~2~ measurements,  then break down how to interpret it. 


```{r}

ggplot(data = nfld, 
       aes( x = city, y = conc)) +
  geom_boxplot()

```


```{r, echo = FALSE}

stJ <- nfld %>%
  filter(city == "St Johns")
stjBox <- boxplot.stats(stJ$conc)

a <- ggplot(stJ, aes(x = city, y= conc)) +
  geom_boxplot() + 
  theme_classic() +
  coord_flip() +
  
  # max value
  annotate("text", x = 1.25, y = 40, label = "Maximal Value\n in the data", hjust = 1) +
  annotate("curve", x = 1.25, xend = 1, y = 40, yend = 49, curvature =-0.5, arrow = arrow(length = unit(4, "mm")))  +
  
  # outliers
  annotate("rect", xmin = 0.95, xmax = 1.05, ymin = 14.5, ymax = 50, alpha = 0.25, colour = "#a63603") +
  annotate("text", x = 1.10, y = 30, label = "Outliers", colour = "#a63603") +
  
  # Maximal
  annotate("text", x = 0.9, y = 15, label = "Maximal (Q3 + 1.5*IQR", hjust = 0) +
  annotate("curve", x = 0.9, xend = 0.99, y = 15, yend = 14, curvature = -0.5, arrow = arrow(length = unit(4, "mm"))) +    
  
  # q3
  annotate("text", x =0.8, y = 13, label = "3rd Quartile (Q3)", hjust = 0 ) +
  annotate("curve", x = 0.8, xend = 0.8, y = 13, yend = 7,curvature = 0, arrow = arrow(length = unit(4, "mm"))) +
  
  # Median
  annotate("text", x = 0.7, y = 11, label = "Median", hjust = 0) +
  annotate("curve", x = 0.7, xend = 0.7, y = 11, yend = 3,curvature = 0, arrow = arrow(length = unit(4, "mm"))) +
  
  # Q1
  annotate("text", x = 0.6, y = 9, label = "1st quartile (Q1)", hjust = 0 ) +
  annotate("curve", x = 0.6, xend = 0.65, y = 9, yend = 2,curvature = -0.3, arrow = arrow(length = unit(4, "mm"))) +
  
  # minimum
  annotate("text", x = 0.5, y = 7, label = "Minimum (Q1 - 1.5*IQR), here it's equal to the min value in the data", hjust = 0 ) +
  annotate("curve", x = 0.5, xend = 1, y = 7, yend = 0,curvature = -0.6, arrow = arrow(length = unit(4, "mm"))) +
  
  # IQR
  annotate("text", x = 1.5, y = 4, label = "Inter quartile range (IQR)", hjust = 0.25) +
  annotate("curve", x = 1.4 , xend = 1.4, y = 7, yend = 2, curvature = 0, arrow = arrow(length = unit(4, "mm"))) +
  annotate("curve", x = 1.4, xend = 1.4, y = 2, yend = 7, curvature = 0, arrow = arrow(length = unit(4, "mm"))) +
  labs(x = "",
       y = "conc")


colors <- c("#feedde", "#fdbe85", "#fd8d3c", "#e6550d", "#a63603")

dens  <- density(stJ$conc)
df <- data.frame(x=dens$x, y=dens$y) %>%
  filter(x > 0)
quantiles <- c(0, 2, 3, 7, 14)

df$quant <- factor(findInterval(df$x,quantiles))

# 
# b <- ggplot(stJ, aes(x = conc)) +
#   geom_density() +
#   theme_classic()


b <- ggplot(df, aes(x,y)) + 
  geom_line() + 
  geom_ribbon(aes(ymin=0, ymax=y, fill=quant)) + 
  scale_fill_manual(values = colors)  +
  theme_classic() + 
  guides(fill = FALSE) +
  labs(x = "conc",
       y = "density") +

  geom_vline(xintercept=14, colour="black") +
  geom_vline(xintercept=7, colour="black") +   
  geom_vline(xintercept=3, colour="black")  +  
  geom_vline(xintercept=2, colour="black") +
  geom_vline(xintercept=0, colour = "black") +
  
  
  annotate("text", x = 26, y = 0.15, label = "75% of data is to the left of Q3", hjust = 0) +
  annotate("curve", x = 26, xend = 7, y = 0.15, yend = 0.15,curvature = 0, arrow = arrow(length = unit(4, "mm"))) +
  annotate("text", x = 22, y = 0.10, label = "50% of data is to the left of the median", hjust = 0) +
  annotate("curve", x = 22, xend = 3, y = 0.10, yend = 0.10,curvature = 0, arrow = arrow(length = unit(4, "mm"))) +
  annotate("text", x = 18, y = 0.05, label = "25% of data is to the left of Q1", hjust = 0) +
  annotate("curve", x = 18, xend = 2, y = 0.05, yend = 0.05,curvature = 0, arrow = arrow(length = unit(4, "mm"))) 

  

ggpubr::ggarrange(a,b, ncol = 1, align = "v")
```


### Box plot alternatives

```{r}
ggplot(data = nfld, 
       aes(x = city, y = conc)) + 
  geom_violin()
```

```{r}

ggplot(data = nfld, 
       aes(x = conc, fill = city)) + 
  geom_density( position = "identity") +
  facet_wrap(~city)
```
```{r}

ggstatsplot::ggbetweenstats(data = nfld, 
                            x = city, 
                            y = conc,
                            plot.type = "boxviolin")

```


## histograms

```{r}
ggplot(data = nfld, 
       aes(x = conc)) +
  geom_histogram()
```
This is a histogram 
  - bin size
  - count, how it works 
  - 
  
```{r}
 ggplot(data = nfld, 
       aes(x = conc, fill = city)) +
  geom_histogram(binwidth = 1,  position = "identity",
                 )
```

```{r}

ggplot(data = nfld, 
       aes(x = conc, fill = city)) + 
  geom_histogram(binwidth = 5, position = "identity") +
  facet_wrap(~city)
```



## Scatter plots

### Displaying linear regression






## Venn diagram

### Venn diagram alternatives 